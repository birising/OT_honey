{% extends "base.html" %}
{% set mode = tags.GLOBAL_MODE_STR %}
{% set kill_switch = tags.KILL_SWITCH %}

{% block title %}Process Overview{% endblock %}

{% block extra_css %}
<style>
    .pid-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        overflow-x: auto;
    }
    .pid-container svg text { font-family: 'Segoe UI', Arial, sans-serif; }
    @keyframes flow-anim {
        from { stroke-dashoffset: 24; }
        to { stroke-dashoffset: 0; }
    }
    .flow-line {
        stroke: #3498db;
        stroke-width: 3;
        stroke-dasharray: 8,4;
        animation: flow-anim 1.5s linear infinite;
    }
    .flow-line.stopped {
        animation: none;
    }
    .tank-fill {
        transition: height 1s ease, y 1s ease;
        opacity: 0.4;
    }
    .faceplate-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    .faceplate {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 2px solid #2c3e50;
        border-radius: 6px;
        padding: 20px;
        min-width: 320px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .faceplate h3 {
        margin: 0 0 15px 0;
        padding-bottom: 8px;
        border-bottom: 2px solid #3498db;
        color: #2c3e50;
    }
    .faceplate .fp-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 13px;
    }
    .faceplate .fp-label { color: #7f8c8d; }
    .faceplate .fp-value { font-weight: 600; font-family: 'Consolas', monospace; }
    .faceplate .fp-controls {
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid #ecf0f1;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .fp-close {
        position: absolute;
        top: 8px; right: 12px;
        cursor: pointer;
        font-size: 18px;
        color: #7f8c8d;
    }
    .status-dot {
        display: inline-block;
        width: 10px; height: 10px;
        border-radius: 50%;
        margin-right: 4px;
    }
    .dot-run { background: #27ae60; }
    .dot-stop { background: #95a5a6; }
    .dot-fault { background: #e74c3c; animation: blink 1s infinite; }
    .pid-info {
        display: flex;
        gap: 20px;
        margin-top: 8px;
        font-size: 11px;
        color: #7f8c8d;
        font-family: monospace;
    }
    .pid-info .pi-label { color: #95a5a6; }
    .pid-info .pi-value { color: #2c3e50; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<h2 style="margin:0 0 8px 0; font-size:14px; color:#2c3e50; text-transform:uppercase; letter-spacing:0.5px;">Process Overview - P&ID</h2>
<div class="pid-info">
    <span>Capacity: 4.5k PE</span>
    <span class="pi-label">Updated: <span class="pi-value" id="last-update">--:--:--</span></span>
    <span class="pi-label">Refresh: 5s</span>
</div>

<div class="pid-container" style="margin-top:8px;">
<svg width="1200" height="340" viewBox="0 0 1200 340">
  <!-- Flow line (animated) -->
  <line x1="0" y1="200" x2="1200" y2="200" class="flow-line" id="flow-line"/>

  <!-- INFLUENT (Wet Well) -->
  <g onclick="showFaceplate('influent')" style="cursor:pointer">
    <rect x="10" y="140" width="100" height="80" rx="3" fill="#eaf4fe" stroke="#2980b9" stroke-width="2" id="box-influent"/>
    <!-- Tank fill -->
    <rect x="11" y="180" width="98" height="39" rx="2" class="tank-fill" fill="#2980b9" id="fill-wetwell"/>
    <text x="60" y="155" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">INFLUENT</text>
    <text x="60" y="167" text-anchor="middle" font-size="8" fill="#7f8c8d">Wet Well</text>
    <!-- Pump symbol -->
    <circle cx="45" cy="195" r="10" fill="#95a5a6" stroke="#2c3e50" stroke-width="1.5" id="pump-101"/>
    <polygon points="40,190 50,195 40,200" fill="white"/>
    <text x="60" y="195" font-size="8" fill="#333">P101</text>
    <text x="60" y="210" font-size="9" fill="#2c3e50" font-weight="bold" id="pv-qin">-- m3/h</text>
    <text x="60" y="222" font-size="8" fill="#7f8c8d" id="pv-lt101">LT: -- m</text>
  </g>

  <!-- Valve VLV101 -->
  <g transform="translate(120,190)">
    <polygon points="0,0 10,10 0,20" fill="#3498db" stroke="#2c3e50" stroke-width="1"/>
    <polygon points="20,0 10,10 20,20" fill="#3498db" stroke="#2c3e50" stroke-width="1"/>
    <text x="10" y="30" text-anchor="middle" font-size="7" fill="#7f8c8d" id="pv-vlv101">V101 --%</text>
  </g>

  <!-- SCREENING -->
  <g onclick="showFaceplate('screening')" style="cursor:pointer">
    <rect x="155" y="150" width="90" height="65" rx="3" fill="#f0f9f0" stroke="#27ae60" stroke-width="2" id="box-screen"/>
    <text x="200" y="168" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">SCREEN</text>
    <text x="200" y="182" text-anchor="middle" font-size="9" fill="#2c3e50" id="pv-scr-dp">DP: -- bar</text>
    <text x="200" y="195" text-anchor="middle" font-size="8" fill="#95a5a6" id="pv-scr-status">OK</text>
    <text x="200" y="208" text-anchor="middle" font-size="7" fill="#7f8c8d" id="pv-scr-mode">AUTO</text>
  </g>

  <!-- GRIT/GREASE -->
  <g onclick="showFaceplate('grit')" style="cursor:pointer">
    <rect x="260" y="150" width="90" height="65" rx="3" fill="#fef9e7" stroke="#f39c12" stroke-width="2"/>
    <text x="305" y="168" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">GRIT/GREASE</text>
    <text x="305" y="182" text-anchor="middle" font-size="9" fill="#2c3e50" id="pv-grt-level">Lvl: -- m</text>
    <text x="305" y="195" text-anchor="middle" font-size="8" fill="#95a5a6" id="pv-grt-skim">Skim: OFF</text>
  </g>

  <!-- PRIMARY CLARIFIER -->
  <g onclick="showFaceplate('primary')" style="cursor:pointer">
    <rect x="365" y="140" width="100" height="80" rx="3" fill="#f5eef8" stroke="#8e44ad" stroke-width="2" id="box-primary"/>
    <!-- Tank fill -->
    <rect x="366" y="180" width="98" height="39" rx="2" class="tank-fill" fill="#8e44ad" id="fill-primary"/>
    <text x="415" y="155" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">PRIMARY</text>
    <text x="415" y="167" text-anchor="middle" font-size="8" fill="#7f8c8d">Clarifier</text>
    <circle cx="395" cy="195" r="10" fill="#95a5a6" stroke="#2c3e50" stroke-width="1.5" id="pump-301"/>
    <polygon points="390,190 400,195 390,200" fill="white"/>
    <text x="415" y="195" font-size="8" fill="#333">P301</text>
    <text x="415" y="210" font-size="9" fill="#2c3e50" id="pv-lt301">LT: -- m</text>
    <text x="415" y="222" font-size="8" fill="#7f8c8d" id="pv-cod-pri">COD: --</text>
  </g>

  <!-- AERATION TANK -->
  <g onclick="showFaceplate('aeration')" style="cursor:pointer">
    <rect x="480" y="130" width="140" height="100" rx="3" fill="#eaf4fe" stroke="#2980b9" stroke-width="2" id="box-aeration"/>
    <!-- Tank fill -->
    <rect x="481" y="190" width="138" height="39" rx="2" class="tank-fill" fill="#2980b9" id="fill-aeration"/>
    <text x="550" y="145" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">AERATION TANK</text>
    <!-- Blower symbol -->
    <circle cx="500" cy="170" r="12" fill="#95a5a6" stroke="#2c3e50" stroke-width="1.5" id="blw-201"/>
    <text x="500" y="173" text-anchor="middle" font-size="7" fill="white" font-weight="bold">B</text>
    <text x="518" y="170" font-size="8" fill="#333" id="pv-blw-pv">BLW201 --%</text>
    <text x="550" y="188" text-anchor="middle" font-size="9" fill="#2c3e50" font-weight="bold" id="pv-do">DO: -- mg/L</text>
    <text x="550" y="200" text-anchor="middle" font-size="8" fill="#7f8c8d" id="pv-do-sp">SP: --</text>
    <text x="550" y="212" text-anchor="middle" font-size="8" fill="#2c3e50" id="pv-aer-extra">pH: -- | T: --C</text>
    <text x="550" y="224" text-anchor="middle" font-size="7" fill="#7f8c8d" id="pv-aer-info">--A | LT: --m</text>
  </g>

  <!-- SECONDARY CLARIFIER -->
  <g onclick="showFaceplate('clarifier')" style="cursor:pointer">
    <rect x="640" y="140" width="110" height="80" rx="3" fill="#fef9e7" stroke="#f39c12" stroke-width="2" id="box-clarifier"/>
    <!-- Tank fill -->
    <rect x="641" y="180" width="108" height="39" rx="2" class="tank-fill" fill="#f39c12" id="fill-clarifier"/>
    <text x="695" y="155" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">SEC. CLARIFIER</text>
    <text x="695" y="170" text-anchor="middle" font-size="9" fill="#2c3e50" id="pv-lt401">LT: -- m</text>
    <circle cx="660" cy="195" r="8" fill="#95a5a6" stroke="#2c3e50" stroke-width="1" id="pump-401"/>
    <text x="673" y="198" font-size="7" fill="#333">RAS</text>
    <circle cx="715" cy="195" r="8" fill="#95a5a6" stroke="#2c3e50" stroke-width="1" id="pump-402"/>
    <text x="728" y="198" font-size="7" fill="#333">WAS</text>
    <text x="695" y="215" text-anchor="middle" font-size="8" fill="#2c3e50" id="pv-tur">TUR: -- NTU</text>
  </g>

  <!-- CHEMICAL DOSING -->
  <g onclick="showFaceplate('chemical')" style="cursor:pointer">
    <rect x="770" y="140" width="110" height="80" rx="3" fill="#eafaf1" stroke="#1abc9c" stroke-width="2" id="box-chemical"/>
    <!-- Tank fill -->
    <rect x="771" y="180" width="108" height="39" rx="2" class="tank-fill" fill="#1abc9c" id="fill-chemical"/>
    <text x="825" y="155" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">CHEMICAL</text>
    <text x="825" y="168" text-anchor="middle" font-size="8" fill="#7f8c8d">FeCl3 Dosing</text>
    <circle cx="790" cy="195" r="8" fill="#95a5a6" stroke="#2c3e50" stroke-width="1" id="pump-501"/>
    <text x="803" y="198" font-size="7" fill="#333">P501</text>
    <text x="825" y="210" font-size="9" fill="#2c3e50" id="pv-dose">-- L/h</text>
    <text x="825" y="222" font-size="8" fill="#7f8c8d" id="pv-tank501">Tank: --%</text>
  </g>

  <!-- Valve VLV501 -->
  <g transform="translate(890,190)">
    <polygon points="0,0 10,10 0,20" fill="#1abc9c" stroke="#2c3e50" stroke-width="1"/>
    <polygon points="20,0 10,10 20,20" fill="#1abc9c" stroke="#2c3e50" stroke-width="1"/>
    <text x="10" y="30" text-anchor="middle" font-size="7" fill="#7f8c8d" id="pv-vlv501">V501 --%</text>
  </g>

  <!-- EFFLUENT -->
  <g onclick="showFaceplate('effluent')" style="cursor:pointer">
    <rect x="925" y="140" width="100" height="80" rx="3" fill="#eaf4fe" stroke="#2980b9" stroke-width="2" id="box-effluent"/>
    <text x="975" y="158" text-anchor="middle" font-size="10" fill="#2c3e50" font-weight="bold">EFFLUENT</text>
    <text x="975" y="175" text-anchor="middle" font-size="9" fill="#2c3e50" id="pv-qout">-- m3/h</text>
    <text x="975" y="190" text-anchor="middle" font-size="8" fill="#2c3e50" id="pv-cod-eff">COD: -- mg/L</text>
    <text x="975" y="203" text-anchor="middle" font-size="8" fill="#2c3e50" id="pv-ph-eff">pH: --</text>
    <text x="975" y="216" text-anchor="middle" font-size="8" fill="#7f8c8d" id="pv-tur-eff">TUR: -- NTU</text>
  </g>

  <!-- Flow direction arrows -->
  <polygon points="145,195 155,200 145,205" fill="#3498db"/>
  <polygon points="250,195 260,200 250,205" fill="#3498db"/>
  <polygon points="355,195 365,200 355,205" fill="#3498db"/>
  <polygon points="470,195 480,200 470,205" fill="#3498db"/>
  <polygon points="625,195 635,200 625,205" fill="#3498db"/>
  <polygon points="755,195 765,200 755,205" fill="#3498db"/>
  <polygon points="915,195 925,200 915,205" fill="#3498db"/>
  <polygon points="1025,195 1035,200 1025,205" fill="#3498db"/>

  <!-- Discharge arrow -->
  <line x1="1025" y1="200" x2="1060" y2="200" stroke="#3498db" stroke-width="3"/>
  <polygon points="1060,195 1070,200 1060,205" fill="#3498db"/>
  <text x="1080" y="204" font-size="9" fill="#7f8c8d">Discharge</text>

  <!-- Flow path label -->
  <text x="600" y="265" text-anchor="middle" font-size="10" fill="#95a5a6">Influent > Screen > Grit > Primary > Aeration > Sec.Clarifier > Chemical > Effluent</text>

  <!-- Legend -->
  <g transform="translate(20,290)">
    <text x="0" y="0" font-size="10" fill="#2c3e50" font-weight="bold">Legend:</text>
    <circle cx="10" cy="15" r="5" fill="#27ae60"/><text x="20" y="19" font-size="9" fill="#333">Running</text>
    <circle cx="80" cy="15" r="5" fill="#95a5a6"/><text x="90" y="19" font-size="9" fill="#333">Stopped</text>
    <circle cx="150" cy="15" r="5" fill="#e74c3c"/><text x="160" y="19" font-size="9" fill="#333">Fault</text>
    <rect x="200" y="10" width="20" height="10" fill="#2980b9" opacity="0.4" rx="1"/><text x="225" y="19" font-size="9" fill="#333">Tank Level</text>
    <text x="310" y="19" font-size="9" fill="#7f8c8d">Click equipment for faceplate controls</text>
  </g>
</svg>
</div>

<!-- Faceplate Overlay -->
<div class="faceplate-overlay" id="faceplate-overlay" onclick="closeFaceplate()">
  <div class="faceplate" id="faceplate-content" onclick="event.stopPropagation()">
    <span class="fp-close" onclick="closeFaceplate()">&times;</span>
    <div id="faceplate-body"></div>
  </div>
</div>

<script>
// Live snapshot data (updated via AJAX)
var S = {};

function gv(tag) {
    return S[tag] ? S[tag].value : 0;
}

function updatePID() {
    // Pump/equipment colors
    function pumpColor(fb, fault) {
        if (fault) return '#e74c3c';
        if (fb) return '#27ae60';
        return '#95a5a6';
    }
    function boxColor(fault, normalFill) {
        return fault ? '#fde8e8' : normalFill;
    }

    // Influent
    var p101fb = gv('WWTP01:INFLUENT:PMP101.FB');
    var p101fault = gv('WWTP01:INFLUENT:PMP101.FAULT');
    var qin = gv('WWTP01:INFLUENT:Q_IN.PV');
    var lt101 = gv('WWTP01:INFLUENT:LT101.PV');
    document.getElementById('pump-101').setAttribute('fill', pumpColor(p101fb, p101fault));
    document.getElementById('box-influent').setAttribute('fill', boxColor(p101fault, '#eaf4fe'));
    document.getElementById('pv-qin').textContent = qin.toFixed(1) + ' m3/h';
    document.getElementById('pv-lt101').textContent = 'LT: ' + lt101.toFixed(2) + ' m';
    // Tank fill: wet well max 3.0m, tank rect height 39px, y starts at 220 (bottom)
    var wwPct = Math.min(lt101 / 3.0, 1.0);
    var wwH = Math.round(wwPct * 39);
    var wwFill = document.getElementById('fill-wetwell');
    wwFill.setAttribute('height', wwH);
    wwFill.setAttribute('y', 220 - wwH);

    // Valve
    document.getElementById('pv-vlv101').textContent = 'V101 ' + gv('WWTP01:INFLUENT:VLV101.POS').toFixed(0) + '%';

    // Flow line speed based on Q_IN
    var fl = document.getElementById('flow-line');
    if (qin < 0.5) { fl.classList.add('stopped'); } else { fl.classList.remove('stopped'); }
    fl.style.animationDuration = Math.max(0.3, 3.0 - (qin / 20) * 2.5).toFixed(1) + 's';

    // Screening
    var scrFault = gv('WWTP01:SCREENING:SCR101.FAULT');
    var scrFb = gv('WWTP01:SCREENING:SCR101.FB');
    var scrAuto = gv('WWTP01:SCREENING:SCR101.AUTO');
    document.getElementById('box-screen').setAttribute('fill', boxColor(scrFault, '#f0f9f0'));
    document.getElementById('pv-scr-dp').textContent = 'DP: ' + gv('WWTP01:SCREENING:SCR101.DP').toFixed(3) + ' bar';
    var scrStatusEl = document.getElementById('pv-scr-status');
    if (scrFault) { scrStatusEl.textContent = 'FAULT'; scrStatusEl.setAttribute('fill', '#e74c3c'); }
    else if (scrFb) { scrStatusEl.textContent = 'CLEANING'; scrStatusEl.setAttribute('fill', '#27ae60'); }
    else { scrStatusEl.textContent = 'OK'; scrStatusEl.setAttribute('fill', '#95a5a6'); }
    document.getElementById('pv-scr-mode').textContent = scrAuto ? 'AUTO' : 'MANUAL';

    // Grit
    document.getElementById('pv-grt-level').textContent = 'Lvl: ' + gv('WWTP01:GRIT:GRT201.LEVEL').toFixed(2) + ' m';
    var grtSkim = gv('WWTP01:GRIT:GRS201.SKIM');
    var grtSkimEl = document.getElementById('pv-grt-skim');
    grtSkimEl.textContent = 'Skim: ' + (grtSkim ? 'ON' : 'OFF');
    grtSkimEl.setAttribute('fill', grtSkim ? '#27ae60' : '#95a5a6');

    // Primary
    var p301fault = gv('WWTP01:PRIMARY:PMP301.FAULT');
    var p301fb = gv('WWTP01:PRIMARY:PMP301.FB');
    var lt301 = gv('WWTP01:PRIMARY:LT301.PV');
    document.getElementById('pump-301').setAttribute('fill', pumpColor(p301fb, p301fault));
    document.getElementById('box-primary').setAttribute('fill', boxColor(p301fault, '#f5eef8'));
    document.getElementById('pv-lt301').textContent = 'LT: ' + lt301.toFixed(2) + ' m';
    document.getElementById('pv-cod-pri').textContent = 'COD: ' + gv('WWTP01:PRIMARY:COD_PRI.PV').toFixed(0);
    var priPct = Math.min(lt301 / 3.0, 1.0);
    var priH = Math.round(priPct * 39);
    var priFill = document.getElementById('fill-primary');
    priFill.setAttribute('height', priH);
    priFill.setAttribute('y', 220 - priH);

    // Aeration
    var blwFault = gv('WWTP01:AERATION:BLW201.FAULT');
    var blwFb = gv('WWTP01:AERATION:BLW201.FB');
    var blwPv = gv('WWTP01:AERATION:BLW201.PV');
    var do301 = gv('WWTP01:AERATION:DO301.PV');
    var doSp = gv('WWTP01:AERATION:DO301.SP');
    var lt201 = gv('WWTP01:AERATION:LT201.PV');
    document.getElementById('blw-201').setAttribute('fill', pumpColor(blwFb, blwFault));
    document.getElementById('box-aeration').setAttribute('fill', boxColor(blwFault, '#eaf4fe'));
    document.getElementById('pv-blw-pv').textContent = 'BLW201 ' + blwPv.toFixed(0) + '%';
    document.getElementById('pv-do').textContent = 'DO: ' + do301.toFixed(2) + ' mg/L';
    document.getElementById('pv-do-sp').textContent = 'SP: ' + doSp.toFixed(2);
    document.getElementById('pv-aer-extra').textContent = 'pH: ' + gv('WWTP01:AERATION:pH302.PV').toFixed(1) + ' | T: ' + gv('WWTP01:AERATION:TEMP303.PV').toFixed(1) + 'C';
    document.getElementById('pv-aer-info').textContent = gv('WWTP01:AERATION:BLW201.CURRENT').toFixed(1) + 'A | LT: ' + lt201.toFixed(2) + 'm';
    var aerPct = Math.min(lt201 / 3.5, 1.0);
    var aerH = Math.round(aerPct * 39);
    var aerFill = document.getElementById('fill-aeration');
    aerFill.setAttribute('height', aerH);
    aerFill.setAttribute('y', 230 - aerH);

    // Clarifier
    var lt401 = gv('WWTP01:CLARIFIER:LT401.PV');
    var p401fb = gv('WWTP01:CLARIFIER:PMP401.FB');
    var p402fb = gv('WWTP01:CLARIFIER:PMP402.FB');
    document.getElementById('pump-401').setAttribute('fill', p401fb ? '#27ae60' : '#95a5a6');
    document.getElementById('pump-402').setAttribute('fill', p402fb ? '#27ae60' : '#95a5a6');
    document.getElementById('pv-lt401').textContent = 'LT: ' + lt401.toFixed(2) + ' m';
    document.getElementById('pv-tur').textContent = 'TUR: ' + gv('WWTP01:CLARIFIER:TUR501.PV').toFixed(1) + ' NTU';
    var clrPct = Math.min(lt401 / 3.0, 1.0);
    var clrH = Math.round(clrPct * 39);
    var clrFill = document.getElementById('fill-clarifier');
    clrFill.setAttribute('height', clrH);
    clrFill.setAttribute('y', 220 - clrH);

    // Chemical
    var p501fb = gv('WWTP01:CHEMICAL:PMP501.FB');
    var tank501 = gv('WWTP01:CHEMICAL:TANK501.LEVEL');
    document.getElementById('pump-501').setAttribute('fill', p501fb ? '#27ae60' : '#95a5a6');
    document.getElementById('box-chemical').setAttribute('fill', tank501 < 10 ? '#fde8e8' : '#eafaf1');
    document.getElementById('pv-dose').textContent = gv('WWTP01:CHEMICAL:DOSE_FECL3.PV').toFixed(1) + ' L/h';
    var tankEl = document.getElementById('pv-tank501');
    tankEl.textContent = 'Tank: ' + tank501.toFixed(0) + '%';
    tankEl.setAttribute('fill', tank501 < 10 ? '#e74c3c' : '#7f8c8d');
    var chemPct = Math.min(tank501 / 100, 1.0);
    var chemH = Math.round(chemPct * 39);
    var chemFill = document.getElementById('fill-chemical');
    chemFill.setAttribute('height', chemH);
    chemFill.setAttribute('y', 220 - chemH);

    // Valve VLV501
    document.getElementById('pv-vlv501').textContent = 'V501 ' + gv('WWTP01:CHEMICAL:VLV501.POS').toFixed(0) + '%';

    // Effluent
    var cod501 = gv('WWTP01:EFFLUENT:COD501.PV');
    var tur501 = gv('WWTP01:CLARIFIER:TUR501.PV');
    document.getElementById('box-effluent').setAttribute('fill', cod501 > 40 ? '#fde8e8' : '#eaf4fe');
    document.getElementById('pv-qout').textContent = gv('WWTP01:EFFLUENT:Q_OUT.PV').toFixed(1) + ' m3/h';
    var codEl = document.getElementById('pv-cod-eff');
    codEl.textContent = 'COD: ' + cod501.toFixed(1) + ' mg/L';
    codEl.setAttribute('fill', cod501 > 40 ? '#e74c3c' : '#2c3e50');
    document.getElementById('pv-ph-eff').textContent = 'pH: ' + gv('WWTP01:EFFLUENT:pH501.PV').toFixed(2);
    var turEl = document.getElementById('pv-tur-eff');
    turEl.textContent = 'TUR: ' + tur501.toFixed(1) + ' NTU';
    turEl.setAttribute('fill', tur501 > 5 ? '#e74c3c' : '#7f8c8d');

    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

function fetchSnapshot() {
    fetch('/api/snapshot')
    .then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
    })
    .then(function(data) {
        S = data;
        updatePID();
    })
    .catch(function(err) {
        console.error('Snapshot fetch error:', err);
    });
}

// Faceplate system - generates from live data
function showFaceplate(id) {
    var html = '';
    var controls = [];

    if (id === 'influent') {
        html = fpHeader('PMP101 - Influent Pump');
        html += fpRow('Status', gv('WWTP01:INFLUENT:PMP101.FB') ? 'RUNNING' : 'STOPPED', gv('WWTP01:INFLUENT:PMP101.FB') ? '#27ae60' : '#95a5a6');
        html += fpRow('Mode', gv('WWTP01:INFLUENT:PMP101.AUTO') ? 'AUTO' : 'MANUAL');
        html += fpRow('Flow', gv('WWTP01:INFLUENT:Q_IN.PV').toFixed(2) + ' m3/h');
        html += fpRow('Level', gv('WWTP01:INFLUENT:LT101.PV').toFixed(2) + ' m');
        html += fpRow('Valve VLV101', gv('WWTP01:INFLUENT:VLV101.POS').toFixed(0) + '%');
        html += fpRow('Runtime', gv('WWTP01:INFLUENT:PMP101.RUNTIME').toFixed(1) + ' h');
        html += fpRow('Fault', gv('WWTP01:INFLUENT:PMP101.FAULT') ? 'YES' : 'No', gv('WWTP01:INFLUENT:PMP101.FAULT') ? '#e74c3c' : '#27ae60');
        controls = [
            {label:'Start', tag:'WWTP01:INFLUENT:PMP101.CMD', value:1, cls:'btn-success'},
            {label:'Stop', tag:'WWTP01:INFLUENT:PMP101.CMD', value:0, cls:'btn-danger'},
            {label: gv('WWTP01:INFLUENT:PMP101.AUTO') ? 'Set Manual' : 'Set Auto', tag:'WWTP01:INFLUENT:PMP101.AUTO', value: gv('WWTP01:INFLUENT:PMP101.AUTO') ? 0 : 1, cls:'btn-warning'}
        ];
    } else if (id === 'screening') {
        html = fpHeader('SCR101 - Screening');
        var scrF = gv('WWTP01:SCREENING:SCR101.FAULT');
        var scrFb = gv('WWTP01:SCREENING:SCR101.FB');
        html += fpRow('Status', scrF ? 'FAULT' : (scrFb ? 'CLEANING' : 'OK'), scrF ? '#e74c3c' : (scrFb ? '#27ae60' : '#95a5a6'));
        html += fpRow('Mode', gv('WWTP01:SCREENING:SCR101.AUTO') ? 'AUTO' : 'MANUAL');
        html += fpRow('Diff. Pressure', gv('WWTP01:SCREENING:SCR101.DP').toFixed(3) + ' bar');
        html += fpRow('Fault', scrF ? 'YES' : 'No', scrF ? '#e74c3c' : '#27ae60');
        controls = [
            {label:'Clean', tag:'WWTP01:SCREENING:SCR101.CMD', value:1, cls:'btn-success'},
            {label: gv('WWTP01:SCREENING:SCR101.AUTO') ? 'Set Manual' : 'Set Auto', tag:'WWTP01:SCREENING:SCR101.AUTO', value: gv('WWTP01:SCREENING:SCR101.AUTO') ? 0 : 1, cls:'btn-warning'}
        ];
    } else if (id === 'grit') {
        html = fpHeader('GRT201 - Grit/Grease Chamber');
        html += fpRow('Level', gv('WWTP01:GRIT:GRT201.LEVEL').toFixed(2) + ' m');
        html += fpRow('Skimmer', gv('WWTP01:GRIT:GRS201.SKIM') ? 'ACTIVE' : 'OFF', gv('WWTP01:GRIT:GRS201.SKIM') ? '#27ae60' : '#95a5a6');
    } else if (id === 'primary') {
        html = fpHeader('PMP301 - Primary Clarifier Pump');
        html += fpRow('Status', gv('WWTP01:PRIMARY:PMP301.FB') ? 'RUNNING' : 'STOPPED', gv('WWTP01:PRIMARY:PMP301.FB') ? '#27ae60' : '#95a5a6');
        html += fpRow('Mode', gv('WWTP01:PRIMARY:PMP301.AUTO') ? 'AUTO' : 'MANUAL');
        html += fpRow('Level', gv('WWTP01:PRIMARY:LT301.PV').toFixed(2) + ' m');
        html += fpRow('COD after settling', gv('WWTP01:PRIMARY:COD_PRI.PV').toFixed(0) + ' mg/L');
        html += fpRow('Runtime', gv('WWTP01:PRIMARY:PMP301.RUNTIME').toFixed(1) + ' h');
        html += fpRow('Fault', gv('WWTP01:PRIMARY:PMP301.FAULT') ? 'YES' : 'No', gv('WWTP01:PRIMARY:PMP301.FAULT') ? '#e74c3c' : '#27ae60');
        controls = [
            {label:'Start', tag:'WWTP01:PRIMARY:PMP301.CMD', value:1, cls:'btn-success'},
            {label:'Stop', tag:'WWTP01:PRIMARY:PMP301.CMD', value:0, cls:'btn-danger'},
            {label: gv('WWTP01:PRIMARY:PMP301.AUTO') ? 'Set Manual' : 'Set Auto', tag:'WWTP01:PRIMARY:PMP301.AUTO', value: gv('WWTP01:PRIMARY:PMP301.AUTO') ? 0 : 1, cls:'btn-warning'}
        ];
    } else if (id === 'aeration') {
        html = fpHeader('BLW201 - Aeration Blower');
        var bFault = gv('WWTP01:AERATION:BLW201.FAULT');
        var bFb = gv('WWTP01:AERATION:BLW201.FB');
        html += fpRow('Status', bFault ? 'FAULT' : (bFb ? 'RUNNING' : 'STOPPED'), bFault ? '#e74c3c' : (bFb ? '#27ae60' : '#95a5a6'));
        html += fpRow('Speed', gv('WWTP01:AERATION:BLW201.PV').toFixed(1) + '% (SP: ' + gv('WWTP01:AERATION:BLW201.SP').toFixed(1) + '%)');
        html += fpRow('Current', gv('WWTP01:AERATION:BLW201.CURRENT').toFixed(2) + ' A');
        html += fpRow('DO', gv('WWTP01:AERATION:DO301.PV').toFixed(2) + ' mg/L (SP: ' + gv('WWTP01:AERATION:DO301.SP').toFixed(2) + ')');
        html += fpRow('pH', gv('WWTP01:AERATION:pH302.PV').toFixed(2));
        html += fpRow('Temperature', gv('WWTP01:AERATION:TEMP303.PV').toFixed(1) + ' C');
        html += fpRow('Tank Level', gv('WWTP01:AERATION:LT201.PV').toFixed(2) + ' m');
        html += fpRow('Runtime', gv('WWTP01:AERATION:BLW201.RUNTIME').toFixed(1) + ' h');
        html += fpRow('Fault', bFault ? 'YES' : 'No', bFault ? '#e74c3c' : '#27ae60');
        controls = [
            {label:'Start', tag:'WWTP01:AERATION:BLW201.CMD', value:1, cls:'btn-success'},
            {label:'Stop', tag:'WWTP01:AERATION:BLW201.CMD', value:0, cls:'btn-danger'},
            {label: gv('WWTP01:AERATION:BLW201.AUTO') ? 'Set Manual' : 'Set Auto', tag:'WWTP01:AERATION:BLW201.AUTO', value: gv('WWTP01:AERATION:BLW201.AUTO') ? 0 : 1, cls:'btn-warning'}
        ];
    } else if (id === 'clarifier') {
        html = fpHeader('Secondary Clarifier');
        html += fpRow('Level', gv('WWTP01:CLARIFIER:LT401.PV').toFixed(2) + ' m');
        html += fpRow('Turbidity', gv('WWTP01:CLARIFIER:TUR501.PV').toFixed(1) + ' NTU');
        html += fpRow('RAS Pump 401', gv('WWTP01:CLARIFIER:PMP401.FB') ? 'RUNNING' : 'STOPPED', gv('WWTP01:CLARIFIER:PMP401.FB') ? '#27ae60' : '#95a5a6');
        html += fpRow('WAS Pump 402', gv('WWTP01:CLARIFIER:PMP402.FB') ? 'RUNNING' : 'STOPPED', gv('WWTP01:CLARIFIER:PMP402.FB') ? '#27ae60' : '#95a5a6');
        controls = [
            {label:'RAS Start', tag:'WWTP01:CLARIFIER:PMP401.CMD', value:1, cls:'btn-success'},
            {label:'RAS Stop', tag:'WWTP01:CLARIFIER:PMP401.CMD', value:0, cls:'btn-danger'},
            {label:'WAS Start', tag:'WWTP01:CLARIFIER:PMP402.CMD', value:1, cls:'btn-success'},
            {label:'WAS Stop', tag:'WWTP01:CLARIFIER:PMP402.CMD', value:0, cls:'btn-danger'}
        ];
    } else if (id === 'chemical') {
        html = fpHeader('PMP501 - Chemical Dosing');
        html += fpRow('Status', gv('WWTP01:CHEMICAL:PMP501.FB') ? 'RUNNING' : 'STOPPED', gv('WWTP01:CHEMICAL:PMP501.FB') ? '#27ae60' : '#95a5a6');
        html += fpRow('FeCl3 Rate', gv('WWTP01:CHEMICAL:DOSE_FECL3.PV').toFixed(1) + ' L/h (SP: ' + gv('WWTP01:CHEMICAL:DOSE_FECL3.SP').toFixed(1) + ')');
        html += fpRow('Tank Level', gv('WWTP01:CHEMICAL:TANK501.LEVEL').toFixed(0) + '%');
        html += fpRow('Valve VLV501', gv('WWTP01:CHEMICAL:VLV501.POS').toFixed(0) + '%');
        controls = [
            {label:'Start', tag:'WWTP01:CHEMICAL:PMP501.CMD', value:1, cls:'btn-success'},
            {label:'Stop', tag:'WWTP01:CHEMICAL:PMP501.CMD', value:0, cls:'btn-danger'}
        ];
    } else if (id === 'effluent') {
        html = fpHeader('Effluent');
        html += fpRow('Flow', gv('WWTP01:EFFLUENT:Q_OUT.PV').toFixed(1) + ' m3/h');
        html += fpRow('COD', gv('WWTP01:EFFLUENT:COD501.PV').toFixed(1) + ' mg/L');
        html += fpRow('pH', gv('WWTP01:EFFLUENT:pH501.PV').toFixed(2));
        html += fpRow('Turbidity', gv('WWTP01:CLARIFIER:TUR501.PV').toFixed(1) + ' NTU');
    }

    if (controls.length > 0) {
        html += '<div class="fp-controls">';
        for (var i = 0; i < controls.length; i++) {
            var c = controls[i];
            html += '<button class="btn ' + c.cls + '" onclick="writeTag(\'' + c.tag + '\',' + c.value + ')">' + c.label + '</button>';
        }
        html += '</div>';
    }

    document.getElementById('faceplate-body').innerHTML = html;
    document.getElementById('faceplate-overlay').style.display = 'block';
}

function fpHeader(title) {
    return '<h3>' + title + '</h3>';
}
function fpRow(label, value, color) {
    var style = color ? ' style="color:' + color + '"' : '';
    return '<div class="fp-row"><span class="fp-label">' + label + '</span><span class="fp-value"' + style + '>' + value + '</span></div>';
}

function closeFaceplate() {
    document.getElementById('faceplate-overlay').style.display = 'none';
}

function writeTag(tag, value) {
    fetch('/api/write', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag: tag, value: value})
    }).then(function(resp) {
        return resp.json();
    }).then(function() {
        closeFaceplate();
        fetchSnapshot();
    });
}

// Initial fetch and periodic update (no page reload)
fetchSnapshot();
setInterval(fetchSnapshot, 5000);
</script>
{% endblock %}
